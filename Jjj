
--[[
    SimpleSpy v2.2 (Stealth Edition)
    Credits:
        exx - original creator
        Frosty - GUI to Lua
        Enhanced for stealth and mobile
]]

-- Скрываем скрипт от античита
local function secureLoad()
    local secureEnv = {
        game = game,
        workspace = workspace,
        script = script,
        getfenv = getfenv,
        setfenv = setfenv,
        loadstring = loadstring,
        pcall = pcall,
        xpcall = xpcall,
        coroutine = coroutine,
        require = require,
        spawn = spawn,
        delay = delay,
        tick = tick,
        time = time,
        wait = wait,
        warn = warn,
        print = print,
        type = type,
        typeof = typeof,
        tostring = tostring,
        tonumber = tonumber,
        unpack = unpack,
        table = table,
        string = string,
        math = math,
        Vector2 = Vector2,
        Vector3 = Vector3,
        Color3 = Color3,
        UDim2 = UDim2,
        UDim = UDim,
        Instance = Instance,
        Enum = Enum,
        Axes = Axes,
        BrickColor = BrickColor,
        CFrame = CFrame,
        ColorSequence = ColorSequence,
        Faces = Faces,
        NumberRange = NumberRange,
        NumberSequence = NumberSequence,
        PathWaypoint = PathWaypoint,
        PhysicalProperties = PhysicalProperties,
        Random = Random,
        Ray = Ray,
        Rect = Rect,
        Region3 = Region3,
        Region3int16 = Region3int16,
        TweenInfo = TweenInfo,
        getgenv = getgenv or function() return _G end,
        getrenv = getrenv or function() return getfenv() end,
        gethui = gethui or function() return game:GetService("CoreGui") end,
        getreg = getreg or function() return debug.getregistry() end,
        getgc = getgc or function() return {} end,
        getnilinstances = getnilinstances or function() return {} end,
        getsenv = getsenv or function() return getfenv() end,
        getthreadcontext = getthreadcontext or function() return 0 end,
        getcallingscript = getcallingscript or function() return nil end,
        islclosure = islclosure or function(f) return true end,
        checkcaller = checkcaller or function() return false end,
        clonefunction = clonefunction or function(f) return f end,
        setclipboard = setclipboard or function() end,
        newcclosure = newcclosure or function(f) return f end,
        hookfunction = hookfunction or function(f, g) return f end,
        getnamecallmethod = getnamecallmethod or function() return "" end,
        getrawmetatable = getrawmetatable or function(t) return getmetatable(t) end,
        setreadonly = setreadonly or function() end
    }
    
    -- Загружаем скрипт в защищенном окружении
    local func, err = loadstring(script.Source, "SimpleSpy")
    if not func then
        warn("SimpleSpy Load Error:", err)
        return
    end
    
    setfenv(func, setmetatable(secureEnv, {__index = getfenv()}))
    return func()
end

-- Запускаем в защищенном режиме
local success, result = pcall(secureLoad)
if not success then
    warn("SimpleSpy failed to load securely:", result)
end

-- Далее оригинальный код с модификациями
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local TextService = game:GetService("TextService")
local HttpService = game:GetService("HttpService")

-- Загружаем Highlight библиотеку
local Highlight
pcall(function()
    Highlight = loadstring(game:HttpGet("https://github.com/exxtremestuffs/SimpleSpySource/raw/master/highlight.lua"))()
end)

-- Если не удалось загрузить, создаем простую заглушку
if not Highlight then
    Highlight = {}
    function Highlight.new(frame)
        local obj = {}
        function obj:setRaw(text)
            if frame:FindFirstChild("CodeBox") then
                frame.CodeBox.Text = text
            end
        end
        function obj:getString()
            if frame:FindFirstChild("CodeBox") then
                return frame.CodeBox.Text
            end
            return ""
        end
        return obj
    end
end

-- Создаем случайный идентификатор для скрытия от античита
local spyId = HttpService:GenerateGUID(false):sub(1, 8)
local spyName = "UI_" .. spyId

-- Глобальная переменная скрытого типа
local SimpleSpyGlobal = {
    _version = "2.2.stealth",
    _loaded = false,
    _instance = nil
}

-- Создаем главный GUI
local SimpleSpy2 = Instance.new("ScreenGui")
SimpleSpy2.Name = spyName
SimpleSpy2.ResetOnSpawn = false
SimpleSpy2.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
SimpleSpy2.IgnoreGuiInset = true

-- Скрытая кнопка для показа/скрытия (круглая, полупрозрачная)
local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "ToggleBtn"
ToggleButton.Parent = SimpleSpy2
ToggleButton.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
ToggleButton.BackgroundTransparency = 0.3
ToggleButton.BorderSizePixel = 0
ToggleButton.Position = UDim2.new(0, 20, 0, 20)
ToggleButton.Size = UDim2.new(0, 40, 0, 40)
ToggleButton.Text = "S"
ToggleButton.TextColor3 = Color3.fromRGB(220, 220, 220)
ToggleButton.TextSize = 18
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.AutoButtonColor = true
ToggleButton.Visible = true

-- Эффект округления
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(1, 0)
UICorner.Parent = ToggleButton

-- Эффект тени
local UIStroke = Instance.new("UIStroke")
UIStroke.Color = Color3.fromRGB(100, 100, 100)
UIStroke.Thickness = 1
UIStroke.Parent = ToggleButton

-- Главное окно (скрыто по умолчанию)
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainWindow"
MainFrame.Parent = SimpleSpy2
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
MainFrame.BackgroundTransparency = 0.05
MainFrame.BorderSizePixel = 0
MainFrame.Position = UDim2.new(0.5, -250, 0.5, -175)
MainFrame.Size = UDim2.new(0, 500, 0, 350)
MainFrame.Visible = false
MainFrame.Active = true
MainFrame.Selectable = true
MainFrame.Draggable = true

-- Эффект размытия фона
local BlurEffect = Instance.new("BlurEffect")
BlurEffect.Size = 10
BlurEffect.Parent = MainFrame

-- Эффект скругления окна
local WindowCorner = Instance.new("UICorner")
WindowCorner.CornerRadius = UDim.new(0, 12)
WindowCorner.Parent = MainFrame

-- Эффект границы
local WindowStroke = Instance.new("UIStroke")
WindowStroke.Color = Color3.fromRGB(60, 60, 70)
WindowStroke.Thickness = 2
WindowStroke.Parent = MainFrame

-- Эффект тени
local Shadow = Instance.new("ImageLabel")
Shadow.Name = "Shadow"
Shadow.Parent = MainFrame
Shadow.BackgroundTransparency = 1
Shadow.Size = UDim2.new(1, 20, 1, 20)
Shadow.Position = UDim2.new(0, -10, 0, -10)
Shadow.Image = "rbxassetid://5554236805"
Shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
Shadow.ImageTransparency = 0.8
Shadow.ScaleType = Enum.ScaleType.Slice
Shadow.SliceCenter = Rect.new(10, 10, 118, 118)
Shadow.ZIndex = -1

-- Верхняя панель
local TopBar = Instance.new("Frame")
TopBar.Name = "TopBar"
TopBar.Parent = MainFrame
TopBar.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
TopBar.BorderSizePixel = 0
TopBar.Size = UDim2.new(1, 0, 0, 40)

local TopBarCorner = Instance.new("UICorner")
TopBarCorner.CornerRadius = UDim.new(0, 12, 0, 0)
TopBarCorner.Parent = TopBar

-- Заголовок
local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.Parent = TopBar
Title.BackgroundTransparency = 1
Title.Position = UDim2.new(0, 15, 0, 0)
Title.Size = UDim2.new(0, 200, 1, 0)
Title.Font = Enum.Font.GothamMedium
Title.Text = "SIMPLE SPY"
Title.TextColor3 = Color3.fromRGB(220, 220, 220)
Title.TextSize = 18
Title.TextXAlignment = Enum.TextXAlignment.Left

-- Кнопка статуса
local StatusButton = Instance.new("TextButton")
StatusButton.Name = "StatusButton"
StatusButton.Parent = TopBar
StatusButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
StatusButton.BorderSizePixel = 0
StatusButton.Position = UDim2.new(1, -120, 0, 8)
StatusButton.Size = UDim2.new(0, 100, 0, 24)
StatusButton.Font = Enum.Font.Gotham
StatusButton.Text = "ACTIVE"
StatusButton.TextColor3 = Color3.fromRGB(255, 255, 255)
StatusButton.TextSize = 12
StatusButton.AutoButtonColor = false

local StatusCorner = Instance.new("UICorner")
StatusCorner.CornerRadius = UDim.new(0, 4)
StatusCorner.Parent = StatusButton

-- Кнопка закрытия
local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Parent = TopBar
CloseButton.BackgroundTransparency = 1
CloseButton.Position = UDim2.new(1, -40, 0, 0)
CloseButton.Size = UDim2.new(0, 40, 1, 0)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.Text = "×"
CloseButton.TextColor3 = Color3.fromRGB(220, 220, 220)
CloseButton.TextSize = 24
CloseButton.AutoButtonColor = true

-- Основное содержимое
local Content = Instance.new("Frame")
Content.Name = "Content"
Content.Parent = MainFrame
Content.BackgroundTransparency = 1
Content.Position = UDim2.new(0, 0, 0, 40)
Content.Size = UDim2.new(1, 0, 1, -40)

-- Левая панель (логи)
local LeftPanel = Instance.new("Frame")
LeftPanel.Name = "LeftPanel"
LeftPanel.Parent = Content
LeftPanel.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
LeftPanel.BorderSizePixel = 0
LeftPanel.Size = UDim2.new(0, 200, 1, 0)

local LeftPanelCorner = Instance.new("UICorner")
LeftPanelCorner.CornerRadius = UDim.new(0, 0, 0, 12)
LeftPanelCorner.Parent = LeftPanel

-- Заголовок логов
local LogsTitle = Instance.new("TextLabel")
LogsTitle.Name = "LogsTitle"
LogsTitle.Parent = LeftPanel
LogsTitle.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
LogsTitle.BorderSizePixel = 0
LogsTitle.Size = UDim2.new(1, 0, 0, 30)
LogsTitle.Font = Enum.Font.Gotham
LogsTitle.Text = "REMOTE LOGS"
LogsTitle.TextColor3 = Color3.fromRGB(180, 180, 180)
LogsTitle.TextSize = 14

-- Список логов
local LogList = Instance.new("ScrollingFrame")
LogList.Name = "LogList"
LogList.Parent = LeftPanel
LogList.BackgroundTransparency = 1
LogList.BorderSizePixel = 0
LogList.Position = UDim2.new(0, 0, 0, 30)
LogList.Size = UDim2.new(1, 0, 1, -30)
LogList.CanvasSize = UDim2.new(0, 0, 0, 0)
LogList.ScrollBarThickness = 4
LogList.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 100)

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = LogList
UIListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 2)

-- Правая панель
local RightPanel = Instance.new("Frame")
RightPanel.Name = "RightPanel"
RightPanel.Parent = Content
RightPanel.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
RightPanel.BorderSizePixel = 0
RightPanel.Position = UDim2.new(0, 200, 0, 0)
RightPanel.Size = UDim2.new(1, -200, 1, 0)

local RightPanelCorner = Instance.new("UICorner")
RightPanelCorner.CornerRadius = UDim.new(0, 0, 0, 12)
RightPanelCorner.Parent = RightPanel

-- Кодовая панель
local CodeBoxFrame = Instance.new("Frame")
CodeBoxFrame.Name = "CodeBoxFrame"
CodeBoxFrame.Parent = RightPanel
CodeBoxFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
CodeBoxFrame.BorderSizePixel = 0
CodeBoxFrame.Size = UDim2.new(1, 0, 0.7, 0)

local CodeBox = Instance.new("TextBox")
CodeBox.Name = "CodeBox"
CodeBox.Parent = CodeBoxFrame
CodeBox.BackgroundTransparency = 1
CodeBox.Position = UDim2.new(0, 10, 0, 10)
CodeBox.Size = UDim2.new(1, -20, 1, -20)
CodeBox.Font = Enum.Font.Code
CodeBox.Text = "-- SimpleSpy v2.2 (Stealth Edition)\n-- Select a remote to view generated script"
CodeBox.TextColor3 = Color3.fromRGB(220, 220, 220)
CodeBox.TextSize = 12
CodeBox.TextXAlignment = Enum.TextXAlignment.Left
CodeBox.TextYAlignment = Enum.TextYAlignment.Top
CodeBox.ClearTextOnFocus = false
CodeBox.MultiLine = true
CodeBox.TextWrapped = true

-- Панель функций
local FunctionsPanel = Instance.new("Frame")
FunctionsPanel.Name = "FunctionsPanel"
FunctionsPanel.Parent = RightPanel
FunctionsPanel.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
FunctionsPanel.BorderSizePixel = 0
FunctionsPanel.Position = UDim2.new(0, 0, 0.7, 0)
FunctionsPanel.Size = UDim2.new(1, 0, 0.3, 0)

local FunctionsScrolling = Instance.new("ScrollingFrame")
FunctionsScrolling.Name = "FunctionsScrolling"
FunctionsScrolling.Parent = FunctionsPanel
FunctionsScrolling.BackgroundTransparency = 1
FunctionsScrolling.BorderSizePixel = 0
FunctionsScrolling.Size = UDim2.new(1, 0, 1, 0)
FunctionsScrolling.CanvasSize = UDim2.new(0, 0, 0, 0)
FunctionsScrolling.ScrollBarThickness = 4
FunctionsScrolling.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 100)

local FunctionsGrid = Instance.new("UIGridLayout")
FunctionsGrid.Parent = FunctionsScrolling
FunctionsGrid.HorizontalAlignment = Enum.HorizontalAlignment.Center
FunctionsGrid.SortOrder = Enum.SortOrder.LayoutOrder
FunctionsGrid.CellPadding = UDim2.new(0, 5, 0, 5)
FunctionsGrid.CellSize = UDim2.new(0, 120, 0, 32)

-- Подсказка
local ToolTip = Instance.new("Frame")
ToolTip.Name = "ToolTip"
ToolTip.Parent = SimpleSpy2
ToolTip.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
ToolTip.BorderSizePixel = 0
ToolTip.Size = UDim2.new(0, 250, 0, 60)
ToolTip.ZIndex = 100
ToolTip.Visible = false
ToolTip.Active = false

local ToolTipCorner = Instance.new("UICorner")
ToolTipCorner.CornerRadius = UDim.new(0, 6)
ToolTipCorner.Parent = ToolTip

local ToolTipStroke = Instance.new("UIStroke")
ToolTipStroke.Color = Color3.fromRGB(60, 60, 70)
ToolTipStroke.Thickness = 1
ToolTipStroke.Parent = ToolTip

local ToolTipText = Instance.new("TextLabel")
ToolTipText.Name = "TextLabel"
ToolTipText.Parent = ToolTip
ToolTipText.BackgroundTransparency = 1
ToolTipText.Position = UDim2.new(0, 10, 0, 10)
ToolTipText.Size = UDim2.new(1, -20, 1, -20)
ToolTipText.Font = Enum.Font.Gotham
ToolTipText.Text = "Tooltip text"
ToolTipText.TextColor3 = Color3.fromRGB(220, 220, 220)
ToolTipText.TextSize = 12
ToolTipText.TextWrapped = true
ToolTipText.TextXAlignment = Enum.TextXAlignment.Left
ToolTipText.TextYAlignment = Enum.TextYAlignment.Top

-- Шаблон для удалённого элемента
local RemoteTemplate = Instance.new("Frame")
RemoteTemplate.Name = "RemoteTemplate"
RemoteTemplate.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
RemoteTemplate.BorderSizePixel = 0
RemoteTemplate.Size = UDim2.new(0.95, 0, 0, 36)

local RemoteCorner = Instance.new("UICorner")
RemoteCorner.CornerRadius = UDim.new(0, 6)
RemoteCorner.Parent = RemoteTemplate

local RemoteStroke = Instance.new("UIStroke")
RemoteStroke.Color = Color3.fromRGB(60, 60, 70)
RemoteStroke.Thickness = 1
RemoteStroke.Parent = RemoteTemplate

local RemoteButton = Instance.new("TextButton")
RemoteButton.Name = "Button"
RemoteButton.Parent = RemoteTemplate
RemoteButton.BackgroundTransparency = 1
RemoteButton.Size = UDim2.new(1, 0, 1, 0)
RemoteButton.Font = Enum.Font.Gotham
RemoteButton.Text = ""
RemoteButton.TextColor3 = Color3.new(0, 0, 0)
RemoteButton.TextSize = 14
RemoteButton.AutoButtonColor = false

local RemoteText = Instance.new("TextLabel")
RemoteText.Name = "Text"
RemoteText.Parent = RemoteTemplate
RemoteText.BackgroundTransparency = 1
RemoteText.Position = UDim2.new(0, 10, 0, 0)
RemoteText.Size = UDim2.new(1, -20, 1, 0)
RemoteText.Font = Enum.Font.Gotham
RemoteText.Text = "RemoteName"
RemoteText.TextColor3 = Color3.fromRGB(220, 220, 220)
RemoteText.TextSize = 12
RemoteText.TextXAlignment = Enum.TextXAlignment.Left
RemoteText.TextTruncate = Enum.TextTruncate.AtEnd

-- Шаблон кнопки функции
local FunctionTemplate = Instance.new("Frame")
FunctionTemplate.Name = "FunctionTemplate"
FunctionTemplate.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
FunctionTemplate.BorderSizePixel = 0
FunctionTemplate.Size = UDim2.new(0, 120, 0, 32)

local FunctionCorner = Instance.new("UICorner")
FunctionCorner.CornerRadius = UDim.new(0, 6)
FunctionCorner.Parent = FunctionTemplate

local FunctionStroke = Instance.new("UIStroke")
FunctionStroke.Color = Color3.fromRGB(60, 60, 70)
FunctionStroke.Thickness = 1
FunctionStroke.Parent = FunctionTemplate

local FunctionButton = Instance.new("TextButton")
FunctionButton.Name = "Button"
FunctionButton.Parent = FunctionTemplate
FunctionButton.BackgroundTransparency = 1
FunctionButton.Size = UDim2.new(1, 0, 1, 0)
FunctionButton.Font = Enum.Font.Gotham
FunctionButton.Text = ""
FunctionButton.TextColor3 = Color3.new(0, 0, 0)
FunctionButton.TextSize = 14
FunctionButton.AutoButtonColor = false

local FunctionText = Instance.new("TextLabel")
FunctionText.Name = "Text"
FunctionText.Parent = FunctionTemplate
FunctionText.BackgroundTransparency = 1
FunctionText.Size = UDim2.new(1, 0, 1, 0)
FunctionText.Font = Enum.Font.Gotham
FunctionText.Text = "Function"
FunctionText.TextColor3 = Color3.fromRGB(220, 220, 220)
FunctionText.TextSize = 12

-- Переменные
local isMobile = UserInputService.TouchEnabled
local isVisible = false
local toggle = false
local selected = nil
local logs = {}
local remoteLogs = {}
local blacklist = {}
local blocklist = {}
local layoutOrderNum = 999999999
local remoteSignals = {}
local remoteHooks = {}
local scheduled = {}
local connections = {}
local gm = getrawmetatable(game)
local original = gm.__namecall
local remoteEvent = Instance.new("RemoteEvent")
local remoteFunction = Instance.new("RemoteFunction")
local originalEvent = remoteEvent.FireServer
local originalFunction = remoteFunction.InvokeServer

-- Функции для скрытия от античита
local function secureTable()
    local mt = {
        __index = function(t, k)
            if k == "_secure" then
                return true
            end
            return rawget(t, k) or nil
        end,
        __newindex = function(t, k, v)
            if k:sub(1, 1) == "_" then
                rawset(t, k, v)
            end
        end,
        __metatable = "Locked"
    }
    return setmetatable({}, mt)
end

-- Создаем скрытую глобальную переменную
local secureGlobal = secureTable()
secureGlobal._version = "2.2.stealth"
secureGlobal._loaded = true

-- Функция для безопасного хранения
local function storeInSecureGlobal(key, value)
    if not rawget(secureGlobal, "_store") then
        rawset(secureGlobal, "_store", {})
    end
    secureGlobal._store[key] = value
end

storeInSecureGlobal("SimpleSpy", {
    toggle = function() end,
    shutdown = function() end
})

-- Основные функции GUI
local function updateFunctionCanvas()
    FunctionsScrolling.CanvasSize = UDim2.fromOffset(FunctionsGrid.AbsoluteContentSize.X, FunctionsGrid.AbsoluteContentSize.Y)
end

local function updateRemoteCanvas()
    LogList.CanvasSize = UDim2.fromOffset(UIListLayout.AbsoluteContentSize.X, UIListLayout.AbsoluteContentSize.Y)
end

local function makeToolTip(enable, text)
    if enable then
        ToolTipText.Text = text
        local size = TextService:GetTextSize(ToolTipText.Text, ToolTipText.TextSize, ToolTipText.Font, Vector2.new(230, math.huge))
        ToolTip.Size = UDim2.new(0, math.max(size.X + 20, 250), 0, math.max(size.Y + 20, 60))
        
        local mousePos = UserInputService:GetMouseLocation()
        ToolTip.Position = UDim2.new(0, mousePos.X + 20, 0, mousePos.Y + 20)
        ToolTip.Visible = true
    else
        ToolTip.Visible = false
    end
end

local function newButton(name, description, onClick)
    local button = FunctionTemplate:Clone()
    FunctionText.Text = name
    
    FunctionButton.MouseEnter:Connect(function()
        makeToolTip(true, description())
    end)
    
    FunctionButton.MouseLeave:Connect(function()
        makeToolTip(false)
    end)
    
    FunctionButton.MouseButton1Click:Connect(function()
        onClick(button)
    end)
    
    button.Parent = FunctionsScrolling
    updateFunctionCanvas()
end

local function eventSelect(frame)
    if selected then
        TweenService:Create(selected.Log, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(40, 40, 45)}):Play()
    end
    
    for _, v in pairs(logs) do
        if frame == v.Log then
            selected = v
        end
    end
    
    if selected then
        TweenService:Create(frame, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 70)}):Play()
        CodeBox.Text = selected.GenScript or "-- No script generated"
    end
end

local function newRemote(type, name, gen_script, remote, function_info, blocked, src)
    local remoteFrame = RemoteTemplate:Clone()
    RemoteText.Text = name
    
    local id = Instance.new("IntValue")
    id.Name = "ID"
    id.Value = #logs + 1
    id.Parent = remoteFrame
    
    logs[#logs + 1] = {
        Name = name,
        GenScript = gen_script,
        Function = function_info,
        Remote = remote,
        Log = remoteFrame,
        Blocked = blocked,
        Source = src
    }
    
    if blocked then
        logs[#logs].GenScript = "-- BLOCKED BY SIMPLESPY\n\n" .. (gen_script or "")
    end
    
    local connect = RemoteButton.MouseButton1Click:Connect(function()
        eventSelect(remoteFrame)
    end)
    
    if layoutOrderNum < 1 then
        layoutOrderNum = 999999999
    end
    remoteFrame.LayoutOrder = layoutOrderNum
    layoutOrderNum = layoutOrderNum - 1
    remoteFrame.Parent = LogList
    table.insert(remoteLogs, 1, {connect, remoteFrame})
    updateRemoteCanvas()
end

-- Функции для перетаскивания кнопки
local isDraggingButton = false
local dragStartPosition = nil
local buttonStartPosition = nil

local function startButtonDrag(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or 
       (isMobile and input.UserInputType == Enum.UserInputType.Touch) then
        isDraggingButton = true
        dragStartPosition = input.Position
        buttonStartPosition = ToggleButton.Position
    end
end

local function updateButtonDrag(input)
    if isDraggingButton and (input.UserInputType == Enum.UserInputType.MouseMovement or 
        (isMobile and input.UserInputType == Enum.UserInputType.Touch)) then
        local delta = input.Position - dragStartPosition
        local newPos = UDim2.new(
            buttonStartPosition.X.Scale,
            buttonStartPosition.X.Offset + delta.X,
            buttonStartPosition.Y.Scale,
            buttonStartPosition.Y.Offset + delta.Y
        )
        
        -- Ограничиваем позицию в пределах экрана
        local viewportSize = workspace.CurrentCamera.ViewportSize
        local buttonSize = ToggleButton.AbsoluteSize
        
        local x = math.clamp(newPos.X.Offset, 0, viewportSize.X - buttonSize.X)
        local y = math.clamp(newPos.Y.Offset, 0, viewportSize.Y - buttonSize.Y)
        
        ToggleButton.Position = UDim2.new(0, x, 0, y)
    end
end

local function endButtonDrag(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or 
       (isMobile and input.UserInputType == Enum.UserInputType.Touch) then
        isDraggingButton = false
    end
end

-- Функция показа/скрытия GUI
local function toggleGUI()
    isVisible = not isVisible
    
    if isVisible then
        MainFrame.Visible = true
        TweenService:Create(MainFrame, TweenInfo.new(0.3), {Size = UDim2.new(0, 500, 0, 350)}):Play()
        TweenService:Create(ToggleButton, TweenInfo.new(0.3), {BackgroundColor3 = Color3.fromRGB(76, 175, 80)}):Play()
    else
        TweenService:Create(MainFrame, TweenInfo.new(0.3), {Size = UDim2.new(0, 0, 0, 0)}):Play()
        TweenService:Create(ToggleButton, TweenInfo.new(0.3), {BackgroundColor3 = Color3.fromRGB(45, 45, 50)}):Play()
        
        delay(0.3, function()
            MainFrame.Visible = false
        end)
    end
end

-- Функция переключения состояния Spy
local function toggleSpyState()
    toggle = not toggle
    
    if toggle then
        StatusButton.Text = "ACTIVE"
        StatusButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
        TweenService:Create(ToggleButton, TweenInfo.new(0.3), {BackgroundColor3 = Color3.fromRGB(76, 175, 80)}):Play()
    else
        StatusButton.Text = "INACTIVE"
        StatusButton.BackgroundColor3 = Color3.fromRGB(244, 67, 54)
        if not isVisible then
            TweenService:Create(ToggleButton, TweenInfo.new(0.3), {BackgroundColor3 = Color3.fromRGB(45, 45, 50)}):Play()
        end
    end
end

-- Подключение событий
ToggleButton.MouseButton1Down:Connect(startButtonDrag)
ToggleButton.MouseButton1Up:Connect(endButtonDrag)
ToggleButton.MouseMoved:Connect(updateButtonDrag)
ToggleButton.MouseButton1Click:Connect(toggleGUI)

StatusButton.MouseButton1Click:Connect(toggleSpyState)

CloseButton.MouseButton1Click:Connect(function()
    toggleGUI()
end)

-- Для мобильных устройств
if isMobile then
    ToggleButton.TouchStarted:Connect(startButtonDrag)
    ToggleButton.TouchEnded:Connect(endButtonDrag)
    ToggleButton.TouchMoved:Connect(updateButtonDrag)
    ToggleButton.TouchTap:Connect(toggleGUI)
    
    StatusButton.TouchTap:Connect(toggleSpyState)
    CloseButton.TouchTap:Connect(function() toggleGUI() end)
end

-- Функции сериализации (упрощенные)
local function v2s(value)
    local vtype = typeof(value)
    
    if vtype == "number" then
        return tostring(value)
    elseif vtype == "boolean" then
        return tostring(value)
    elseif vtype == "string" then
        return string.format("%q", value)
    elseif vtype == "Instance" then
        return "game." .. value:GetFullName()
    elseif vtype == "Vector3" then
        return string.format("Vector3.new(%s, %s, %s)", value.X, value.Y, value.Z)
    elseif vtype == "CFrame" then
        local x, y, z = value.Position.X, value.Position.Y, value.Position.Z
        return string.format("CFrame.new(%s, %s, %s)", x, y, z)
    elseif vtype == "Color3" then
        return string.format("Color3.new(%s, %s, %s)", value.R, value.G, value.B)
    else
        return "nil --[[" .. vtype .. "]]"
    end
end

local function genScript(remote, ...)
    local args = {...}
    local scriptText = ""
    
    if #args > 0 then
        scriptText = "local args = {\n"
        for i, v in ipairs(args) do
            scriptText = scriptText .. "    " .. v2s(v) .. ",\n"
        end
        scriptText = scriptText .. "}\n\n"
        scriptText = scriptText .. v2s(remote) .. ":FireServer(unpack(args))"
    else
        scriptText = v2s(remote) .. ":FireServer()"
    end
    
    return scriptText
end

-- Функции перехвата удаленных вызовов (упрощенные)
local function setupHooks()
    if not original then
        original = gm.__namecall
    end
    
    setreadonly(gm, false)
    
    gm.__namecall = newcclosure(function(...)
        local args = {...}
        local method = getnamecallmethod()
        local remote = args[1]
        
        if (method == "FireServer" or method == "InvokeServer") and remote:IsA("RemoteEvent") then
            if toggle then
                local remoteType = remote:IsA("RemoteEvent") and "event" or "function"
                newRemote(remoteType, remote.Name, genScript(remote, unpack(args, 2)), remote, nil, false, nil)
            end
        end
        
        return original(...)
    end)
end

local function shutdown()
    setreadonly(gm, false)
    gm.__namecall = original
    SimpleSpy2:Destroy()
    secureGlobal._loaded = false
end

-- Инициализация
setupHooks()
toggleSpyState() -- Включаем по умолчанию

-- Добавляем GUI в CoreGui
if syn and syn.protect_gui then
    pcall(syn.protect_gui, SimpleSpy2)
end

SimpleSpy2.Parent = gethui and gethui() or CoreGui

-- Добавляем базовые кнопки
newButton(
    "Copy Code",
    function() return "Copy script to clipboard" end,
    function()
        setclipboard(CodeBox.Text)
        makeToolTip(true, "Copied to clipboard!")
        wait(1)
        makeToolTip(false)
    end
)

newButton(
    "Run Code",
    function() return "Execute the script" end,
    function()
        local success, err = pcall(loadstring(CodeBox.Text))
        if success then
            makeToolTip(true, "Script executed successfully!")
        else
            makeToolTip(true, "Execution error: " .. tostring(err))
        end
        wait(2)
        makeToolTip(false)
    end
)

newButton(
    "Clear Logs",
    function() return "Clear all remote logs" end,
    function()
        logs = {}
        for _, v in pairs(LogList:GetChildren()) do
            if not v:IsA("UIListLayout") then
                v:Destroy()
            end
        end
        CodeBox.Text = "-- Logs cleared"
        selected = nil
        makeToolTip(true, "Logs cleared!")
        wait(1)
        makeToolTip(false)
    end
)

newButton(
    "Test Script",
    function() return "Generate test script" end,
    function()
        local testData = {
            Vector3 = Vector3.new(1, 2, 3),
            Color = Color3.new(1, 0, 0),
            Number = 42,
            String = "Test"
        }
        
        CodeBox.Text = "-- Test Script\nlocal test = {\n"
        for k, v in pairs(testData) do
            CodeBox.Text = CodeBox.Text .. "    " .. k .. " = " .. v2s(v) .. ",\n"
        end
        CodeBox.Text = CodeBox.Text .. "}\n\nprint(\"Test complete\")"
        
        makeToolTip(true, "Test script generated!")
        wait(1)
        makeToolTip(false)
    end
)

-- Сохраняем функции в безопасном хранилище
storeInSecureGlobal("toggleSpy", toggleSpyState)
storeInSecureGlobal("shutdown", shutdown)

-- Скрываем от античита
local function obfuscateGlobal()
    -- Создаем случайное имя для глобальной переменной
    local randomName = "G" .. HttpService:GenerateGUID(false):sub(1, 8):gsub("-", "")
    
    -- Сохраняем в случайное место
    getgenv()[randomName] = {
        _ = function() return "Nothing to see here" end,
        __ = secureGlobal
    }
    
    -- Удаляем прямые ссылки
    secureGlobal = nil
end

-- Запускаем обфускацию
spawn(obfuscateGlobal)

print("SimpleSpy Stealth Edition loaded successfully")
print("Toggle button visible at top-left corner")
